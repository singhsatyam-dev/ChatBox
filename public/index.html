<!doctype html>
<html>
  <head>
    <title>ChatterUp</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container">
      <div class="chat-section">
        <div class="header">
          <h2 id="welcome"></h2>
          <span id="userCount"></span>
        </div>

        <div id="emptyState" class="empty">
          No messages yet. Start the conversation
        </div>

        <div id="messages" class="messages"></div>

        <div id="typingIndicator" class="typing"></div>

        <form id="messageForm" class="input-area">
          <input
            id="messageInput"
            placeholder="Type a message..."
            autocomplete="off"
          />
          <button>Send</button>
        </form>
      </div>

      <div class="users-section">
        <h3>Online Users</h3>
        <ul id="userList"></ul>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();

      let username = "";
      while (!username) {
        username = prompt("Enter your name");
        if (username) username = username.trim();
      }

      const welcome = document.getElementById("welcome");
      const messages = document.getElementById("messages");
      const userList = document.getElementById("userList");
      const form = document.getElementById("messageForm");
      const input = document.getElementById("messageInput");
      const userCount = document.getElementById("userCount");
      const typingIndicator = document.getElementById("typingIndicator");

      welcome.innerText = `Welcome ${username}`;
      socket.emit("join", username);

      // Generate avatar color
      function getAvatarColor(name) {
        const colors = ["#FF5733", "#33FF57", "#3357FF", "#F39C12", "#8E44AD"];
        let index = name.charCodeAt(0) % colors.length;
        return colors[index];
      }

      // Chat history
      socket.on("chat:history", (history) => {
        history.forEach(addMessage);
        messages.scrollTop = messages.scrollHeight;
      });

      // Receive new message
      socket.on("chat:message", (message) => {
        addMessage(message);
      });

      // Typing indicator
      let typingTimeout;

      input.addEventListener("input", () => {
        socket.emit("typing");

        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
          typingIndicator.innerText = "";
        }, 1000);
      });

      socket.on("typing", (name) => {
        typingIndicator.innerText = `${name} is typing...`;

        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
          typingIndicator.innerText = "";
        }, 1000);
      });

      // Users list
      socket.on("users:update", (users) => {
        userList.innerHTML = "";
        users.forEach((user) => {
          const li = document.createElement("li");
          li.innerHTML = `<span class="dot"></span> ${user}`;
          userList.appendChild(li);
        });

        userCount.innerText = `${users.length} online`;
      });

      // Send message
      form.addEventListener("submit", (e) => {
        e.preventDefault();
        if (input.value.trim()) {
          socket.emit("chat:message", input.value);
          input.value = "";
        }
      });

      // function to add message
      function addMessage(message) {
        const emptyState = document.getElementById("emptyState");
        if (emptyState) emptyState.style.display = "none";

        const div = document.createElement("div");
        if (message.username === "System") {
          div.className = "system-message";
          div.innerText = message.text;
          messages.appendChild(div);
          return;
        }

        const isOwn = message.username === username;
        div.className = isOwn ? "message own fade-in" : "message fade-in";

        const time = new Date(message.createdAt).toLocaleTimeString();

        const avatarUrl = `https://api.dicebear.com/7.x/adventurer/svg?seed=${message.username}`;
        
        div.innerHTML = `
          <img class="avatar" src="${avatarUrl}" />
          <div class="content">
            <div class="name">${message.username}</div>
            <div>${message.text}</div>
            <div class="time">${time}</div>
          </div>
        `;

        messages.appendChild(div);
        messages.scrollTop = messages.scrollHeight;
      }
    </script>
  </body>
</html>
